name: RDP-Static-Persistent-Advanced

env:
  TZ: 'Asia/Kolkata'
  # A unique key for the user settings. Change this to reset the cache.
  CACHE_KEY: rdp-user-settings-v8

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: "[SETUP 1/7] Checkout for Git Operations"
        # We need to checkout the repo to use git commands if storing backups in another repo.
        uses: actions/checkout@v4

      - name: "[SETUP 2/7] Forcefully Cleanup Stale Tailscale Device via API"
        env:
          TS_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          TS_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
          HOSTNAME: "cardersparadox"
        run: |
          $headers = @{ "Authorization" = "Bearer $($env:TS_API_KEY)" }
          $devicesUri = "https://api.tailscale.com/api/v2/tailnet/$($env:TS_TAILNET)/devices"
          try {
            $devices = Invoke-RestMethod -Uri $devicesUri -Headers $headers
          } catch {
            Write-Error "API call failed. Please verify your TAILSCALE_TAILNET secret and ensure your API Key has Read/Write permissions."
            exit 1
          }
          $device = $devices.devices | Where-Object { $_.hostname -eq $env:HOSTNAME }
          if ($device) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Found old device '$($device.hostname)'. Deleting it."
            $deleteUri = "https://api.tailscale.com/api/v2/device/$($device.id)"
            Invoke-RestMethod -Uri $deleteUri -Method Delete -Headers $headers
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Device deleted successfully."
          } else {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] No previous device named '$($env:HOSTNAME)' found."
          }

      - name: "[SETUP 3/7] Restore Cache to Staging Area"
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: D:\a\staging
          key: ${{ env.CACHE_KEY }}

      - name: "[SETUP 4/7] Configure Windows RDP"
        run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force; netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      - name: "[SETUP 5/7] Create RDP User and Apply Settings"
        env:
          CACHE_HIT: ${{ steps.cache-restore.outputs.cache-hit }}
        run: |
          $username = "cardersparadox"
          $password = "Carding.Git!2024"
          $userProfile = "C:\Users\$username"
          $stagingPath = "D:\a\staging"

          New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

          if ($env:CACHE_HIT -eq 'true' -and (Test-Path "$stagingPath\user_settings.reg")) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Cache hit. Applying restored settings..."

            # ADVANCED CHECK: Wait for the user's explorer.exe process to start.
            $retries = 0
            while (-not (Get-Process -Name explorer -IncludeUserName -ErrorAction SilentlyContinue | Where-Object { $_.UserName.EndsWith($username) }) -and $retries -lt 60) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Waiting for user profile shell to initialize..."
              Start-Sleep -Seconds 2
              $retries++
            }

            if (Get-Process -Name explorer -IncludeUserName -ErrorAction SilentlyContinue | Where-Object { $_.UserName.EndsWith($username) }) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Profile is active. Copying files and importing registry..."

              # Stop explorer to safely apply settings
              Stop-Process -Name explorer -Force

              # Restore files first
              Copy-Item -Path "$stagingPath\Desktop" -Destination $userProfile -Recurse -Force -ErrorAction SilentlyContinue
              Copy-Item -Path "$stagingPath\Edge" -Destination "$userProfile\AppData\Local\Microsoft" -Recurse -Force -ErrorAction SilentlyContinue

              # Restore registry settings
              # Running this as the SYSTEM user to modify another user's hive
              reg import "$stagingPath\user_settings.reg"
              
              # Restart explorer to apply changes
              Start-Process -FilePath "explorer.exe"

              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Settings applied successfully."
            } else {
              Write-Warning "[$(Get-Date -Format 'HH:mm:ss')] User profile did not initialize in time. Skipping cache application."
            }
          } else {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] No cache found or cache is invalid. Starting with a fresh profile."
          }
          echo "RDP_USER=$username" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: "[SETUP 6/7] Install and Connect Tailscale"
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "$env:TEMP\tailscale.exe"
          Start-Process -FilePath "$env:TEMP\tailscale.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="cardersparadox"
          $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          if (-not $tsIP) { Start-Sleep -s 10; $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 }
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: "[ACTIVE 7/7] Maintain Session and Auto-Save"
        shell: powershell
        run: |
          Write-Host "================ RDP ACCESS ================"
          Write-Host "Address:  cardersparadox OR $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host "======================================================"

          $userProfilePath = "C:\Users\cardersparadox"
          $stagingPath = "D:\a\staging"
          $edgeDataPath = "$userProfilePath\AppData\Local\Microsoft\Edge"
          $desktopPath = "$userProfilePath\Desktop"

          # More reasonable backup interval (e.g., 60 seconds)
          $backupIntervalSeconds = 60
          
          while ($true) {
            Start-Sleep -Seconds $backupIntervalSeconds
            
            # Switch to the user's context to ensure correct registry export
            # This requires a bit more setup, so for simplicity in Actions, we run as the current user which has admin rights
            # and can access the necessary registry hive locations.
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Auto-saving settings to staging area..."

            # Backup Desktop
            robocopy $desktopPath "$stagingPath\Desktop" /E /PURGE /R:1 /W:1 | Out-Null
            
            # Backup Edge Data (excluding caches)
            $excludeDirs = @(
                "$edgeDataPath\User Data\Default\Cache",
                "$edgeDataPath\User Data\Default\Code Cache",
                "$edgeDataPath\User Data\Default\Service Worker\CacheStorage"
            )
            robocopy $edgeDataPath "$stagingPath\Edge" /E /PURGE /XD $excludeDirs /R:1 /W:1 | Out-Null
            
            # SAFER BACKUP: Export the Current User's registry hive instead of copying NTUSER.DAT
            # We need to run this within the user's context for HKCU to be correct.
            # A workaround is to load the user's hive temporarily.
            reg load HKLM\user_temp "$userProfilePath\NTUSER.DAT"
            reg export HKLM\user_temp "$stagingPath\user_settings.reg" /y
            reg unload HKLM\user_temp
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Save complete."
          }
          
      - name: Save Staged Settings to Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: D:\a\staging
          key: ${{ env.CACHE_KEY }}
