name: RDP-Static-Persistent-Final

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

env:
  RDP_USER: ${{ secrets.RDP_USERNAME || 'RunnerAdmin' }}
  RDP_PASS: ${{ secrets.RDP_PASSWORD || 'SecureP@ssw0rd!2024' }}
  SAVE_RUNTIME: ${{ secrets.SAVE_RUNTIME || 'true' }}
  IDLE_TIMEOUT_MIN: ${{ secrets.IDLE_TIMEOUT_MIN || '3' }}

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Initialize Distributed State Repository (Primary/Fallback Routing)
        shell: powershell
        env:
          DB_PAT: ${{ secrets.BACKUP_DB_PAT }}
          DB_USER: ${{ secrets.BACKUP_DB_USER }}
          DB_REPO: ${{ secrets.BACKUP_DB_REPO }}
          NATIVE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LOCAL_REPO: ${{ github.repository }}
        run: |
          $fallback = $false
          
          if ([string]::IsNullOrWhiteSpace($env:DB_PAT) -or [string]::IsNullOrWhiteSpace($env:DB_USER) -or [string]::IsNullOrWhiteSpace($env:DB_REPO)) {
              Write-Host "Warning: External database secrets missing. Routing to local repository..." -ForegroundColor Yellow
              $fallback = $true
          } else {
              Write-Host "Authenticating to Primary Database: $env:DB_USER/$env:DB_REPO"
              $repoUrl = "https://$($env:DB_USER):$($env:DB_PAT)@github.com/$($env:DB_USER)/$($env:DB_REPO).git"
              
              $cloneOutput = cmd.exe /c "git clone -q `"$repoUrl`" C:\state-repo 2>&1"
              
              if ($LASTEXITCODE -ne 0 -or -not (Test-Path "C:\state-repo\.git")) {
                  if (-not [string]::IsNullOrWhiteSpace($env:DB_PAT)) {
                      $cloneOutput = $cloneOutput -replace [regex]::Escape($env:DB_PAT), "***"
                  }
                  Write-Host "Git Diagnostic Output: $cloneOutput" -ForegroundColor Yellow
                  Write-Host "Error: Access to primary database denied or repository empty. Routing to fallback..." -ForegroundColor Red
                  $fallback = $true
              } else {
                  Write-Host "Primary database connection established." -ForegroundColor Green
              }
          }
          
          if ($fallback) {
              if (Test-Path "C:\state-repo") { 
                  Remove-Item -Path "C:\state-repo" -Recurse -Force -ErrorAction SilentlyContinue 
              }
              Write-Host "Cloning fallback state database: $env:LOCAL_REPO"
              
              $localRepoUrl = "https://x-access-token:$($env:NATIVE_TOKEN)@github.com/$env:LOCAL_REPO.git"
              $localCloneOutput = cmd.exe /c "git clone -q `"$localRepoUrl`" C:\state-repo 2>&1"
              
              if ($LASTEXITCODE -ne 0 -or -not (Test-Path "C:\state-repo\.git")) { 
                  if (-not [string]::IsNullOrWhiteSpace($env:NATIVE_TOKEN)) {
                      $localCloneOutput = $localCloneOutput -replace [regex]::Escape($env:NATIVE_TOKEN), "***"
                  }
                  Write-Host "Git Diagnostic Output: $localCloneOutput" -ForegroundColor Red
                  Write-Error "CRITICAL: Fallback architecture failed."
                  exit 1 
              }
              Write-Host "Fallback database connection established." -ForegroundColor Green
          }
          
          icacls "C:\state-repo" /grant "Everyone:(OI)(CI)F" /T | Out-Null

      - name: Configure Remote Desktop Services & Deep Debloat
        run: |
          # 1. CPU OPTIMIZATION: KILL TELEMETRY TASKS
          Write-Host "Killing High-CPU Telemetry Tasks (CompatTelRunner)..."
          $telemetryTasks = @(
              "\Microsoft\Windows\Application Experience\Microsoft Compatibility Appraiser",
              "\Microsoft\Windows\Application Experience\ProgramDataUpdater",
              "\Microsoft\Windows\Application Experience\StartupAppTask",
              "\Microsoft\Windows\Autochk\Proxy
