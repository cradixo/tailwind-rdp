name: RDP-Static-Persistent-Corrected

env:
  TZ: 'Asia/Kolkata'
  CACHE_KEY: rdp-user-settings-v9 # Increment the key to ensure a fresh start

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      # Steps 1-3 remain the same (Checkout, Cleanup Tailscale, Restore Cache)
      - name: "[SETUP 1/7] Forcefully Cleanup Stale Tailscale Device via API"
        env:
          TS_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          TS_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
          HOSTNAME: "cardersparadox"
        run: |
          # Same PowerShell script as before to clear old device entries
          $headers = @{ "Authorization" = "Bearer $($env:TS_API_KEY)" }
          $devicesUri = "https://api.tailscale.com/api/v2/tailnet/$($env:TS_TAILNET)/devices"
          try {
            $devices = Invoke-RestMethod -Uri $devicesUri -Headers $headers
          } catch {
            Write-Error "API call failed. Please verify your TAILSCALE_TAILNET secret and API Key permissions."
            exit 1
          }
          $device = $devices.devices | Where-Object { $_.hostname -eq $env:HOSTNAME }
          if ($device) {
            Write-Host "Found and deleting old device '$($device.hostname)'."
            Invoke-RestMethod -Uri "https://api.tailscale.com/api/v2/device/$($device.id)" -Method Delete -Headers $headers
          } else {
            Write-Host "No previous device named '$($env:HOSTNAME)' found."
          }

      - name: "[SETUP 2/7] Restore Cache to Staging Area"
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: D:\a\staging
          key: ${{ env.CACHE_KEY }}

      - name: "[SETUP 3/7] Configure Windows RDP"
        run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force; netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      - name: "[SETUP 4/7] Create RDP User and Apply Settings"
        env:
          CACHE_HIT: ${{ steps.cache-restore.outputs.cache-hit }}
          RDP_USER: "cardersparadox"
          RDP_PASS: "Carding.Git!2024"
        run: |
          $userProfile = "C:\Users\$($env:RDP_USER)"
          $stagingPath = "D:\a\staging"
          
          New-LocalUser -Name $env:RDP_USER -Password (ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force) -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
          
          if ($env:CACHE_HIT -eq 'true' -and (Test-Path "$stagingPath\user_settings.reg")) {
            Write-Host "Cache hit. Applying restored settings..."
            $retries = 0
            while (-not (Test-Path "$userProfile\Desktop") -and $retries -lt 30) {
              Write-Host "Waiting for user profile to initialize..."
              Start-Sleep -Seconds 2; $retries++
            }
            if (Test-Path "$userProfile\Desktop") {
              Write-Host "Profile is active. Copying restored files and importing registry..."
              # Copy files FIRST
              Copy-Item -Path "$stagingPath\Desktop" -Destination $userProfile -Recurse -Force -ErrorAction SilentlyContinue
              Copy-Item -Path "$stagingPath\Edge" -Destination "$userProfile\AppData\Local\Microsoft" -Recurse -Force -ErrorAction SilentlyContinue
              # Run reg import as SYSTEM. This correctly applies settings to the user's hive.
              reg import "$stagingPath\user_settings.reg"
              Write-Host "Settings applied successfully."
            } else {
              Write-Warning "User profile did not initialize in time. Skipping cache application."
            }
          } else {
            Write-Host "No cache found. Starting with a fresh profile."
          }
          echo "RDP_USER=$($env:RDP_USER)" >> $env:GITHUB_ENV
          echo "RDP_PASS=$($env:RDP_PASS)" >> $env:GITHUB_ENV

      - name: "[SETUP 5/7] Install and Connect Tailscale"
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "$env:TEMP\tailscale.exe"
          Start-Process -FilePath "$env:TEMP\tailscale.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="cardersparadox"
          Start-Sleep -s 5
          $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      
      - name: "[ACTIVE 6/7] Setup Background Backup and Maintain Session"
        shell: powershell
        run: |
          Write-Host "================ RDP ACCESS ================"
          Write-Host "Address:  cardersparadox OR $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host "======================================================"
          
          # Define paths and settings for the backup task
          $stagingPath = "D:\a\staging"
          $userProfilePath = "C:\Users\$($env:RDP_USER)"
          $edgeDataPath = "$userProfilePath\AppData\Local\Microsoft\Edge"
          $desktopPath = "$userProfilePath\Desktop"
          $backupScriptPath = "D:\a\backup.ps1"

          # Define Edge directories to exclude for a smaller, faster backup
          $excludeDirs = @(
              "`"$edgeDataPath\User Data\Default\Cache`"",
              "`"$edgeDataPath\User Data\Default\Code Cache`"",
              "`"$edgeDataPath\User Data\Default\Service Worker\CacheStorage`""
          ) -join ' '

          # Create the PowerShell script that the scheduled task will execute
          # This script runs IN THE USER'S CONTEXT, which is key
          $scriptContent = @"
          # Backup Registry - HKCU correctly points to this user's hive
          reg export HKCU `"$stagingPath\user_settings.reg`" /y
          
          # Backup Desktop files
          robocopy `"$desktopPath`" `"$stagingPath\Desktop`" /E /PURGE /R:1 /W:1
          
          # Backup Edge data, excluding cache folders
          robocopy `"$edgeDataPath`" `"$stagingPath\Edge`" /E /PURGE /XD $excludeDirs /R:1 /W:1
          "@
          $scriptContent | Out-File -FilePath $backupScriptPath -Encoding utf8

          # Create a Scheduled Task to run the backup script as the RDP user
          $taskName = "UserSyncBackup"
          $taskAction = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -File `"$backupScriptPath`""
          $taskTrigger = New-ScheduledTaskTrigger -RepetitionInterval (New-TimeSpan -Minutes 2) -Once -At (Get-Date)
          Register-ScheduledTask -TaskName $taskName -Action $taskAction -Trigger $taskTrigger -User $env:RDP_USER -Password $env:RDP_PASS -RunLevel Highest -Force

          Write-Host "SUCCESS: Scheduled task '$taskName' created. It will now back up user settings every 2 minutes."
          
          # Keep the main workflow step alive. The real work is done by the background task.
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Heartbeat: Session active. Background backup task is running."
          }
          
      - name: "[SAVE 7/7] Save Staged Settings to Cache"
        if: always() # This ensures it runs even if the workflow is cancelled
        uses: actions/cache/save@v4
        with:
          path: D:\a\staging
          key: ${{ env.CACHE_KEY }}
