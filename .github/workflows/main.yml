name: RDP-Static-Persistent-Final

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Clone Existing Tailwind Repository
        shell: powershell
        env:
          MY_PAT: ${{ secrets.GH_PAT }}
          NATIVE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $token = $env:MY_PAT
          if ([string]::IsNullOrWhiteSpace($token)) { $token = $env:NATIVE_TOKEN }
          if ([string]::IsNullOrWhiteSpace($token)) { Write-Error "No Token Found"; exit 1 }
          $repoUrl = "https://x-access-token:$token@github.com/cradixo/tailwind-rdp.git"
          git clone $repoUrl C:\state-repo
          if (-not (Test-Path "C:\state-repo\.git")) { Write-Error "Clone Failed"; exit 1 }
          icacls "C:\state-repo" /grant "Everyone:(OI)(CI)F" /T | Out-Null

      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      - name: Create RDP User
        run: |
          $username = "cardersparadox"
          $password = "Carding.Git!2024"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

      - name: Deploy Bulletproof Telemetry Agent & Manual Tools
        run: |
          $agentPath = "C:\state-repo\StateSync.ps1"
          
          # --- COMMON DECLARATIONS (Injected into scripts for scalability) ---
          # This allows easy future upgrades. Just add to these arrays.
          $DataMaps = @(
              '$targetUser = ''cardersparadox''',
              '$userDir = "C:\Users\$targetUser"',
              '$stateRepo = ''C:\state-repo''',
              '$User = New-Object System.Security.Principal.NTAccount($targetUser)',
              '$sid = $User.Translate([System.Security.Principal.SecurityIdentifier]).value',
              '',
              '# [SCHEMA UPGRADE ROOM] Add new registry keys to backup here:',
              '$SyncRegistryMap = @{',
              '    "Themes.reg"           = "Software\Microsoft\Windows\CurrentVersion\Themes"',
              '    "ExplorerAdvanced.reg" = "Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced"',
              '    "StuckRects3.reg"      = "Software\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3"',
              '    "DWM.reg"              = "Software\Microsoft\Windows\DWM"',
              '    "Desktop.reg"          = "Control Panel\Desktop"',
              '}',
              '',
              '#[SCHEMA UPGRADE ROOM] Add new folders to backup here:',
              '$SyncFolderMap = @{',
              '    "LocalAppDataThemes" = "$userDir\AppData\Local\Microsoft\Windows\Themes"',
              '    "AppDataThemes"      = "$userDir\AppData\Roaming\Microsoft\Windows\Themes"',
              '}'
          )
          
          # --- SELF-ELEVATION GUARD CLAUSE ---
          $elevationCheck = @(
            '# --- SELF-ELEVATION GUARD ---',
            '$currentUser = New-Object Security.Principal.WindowsPrincipal ([Security.Principal.WindowsIdentity]::GetCurrent())',
            'if (-not $currentUser.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {',
            '    Start-Process powershell.exe -Verb RunAs -ArgumentList "-NoProfile -File `"$PSCommandPath`"";',
            '    exit;',
            '}'
          )
          
          # 1. MANUAL BACKUP SCRIPT
          $backupScript = $elevationCheck + $DataMaps + @(
              'Write-Host "Forcing Manual Backup..." -ForegroundColor Green',
              'Set-Location $stateRepo',
              '',
              '# --- 1. CAPTURE STATE ---',
              'if (-not (Test-Path "$stateRepo\Registry")) { New-Item -Path "$stateRepo\Registry" -ItemType Directory -Force | Out-Null }',
              'if (-not (Test-Path "$stateRepo\Files")) { New-Item -Path "$stateRepo\Files" -ItemType Directory -Force | Out-Null }',
              '',
              'Write-Host "Exporting dynamic registry mapping..."',
              'foreach ($key in $SyncRegistryMap.Keys) {',
              '    reg export "HKEY_USERS\$sid\$($SyncRegistryMap[$key])" "$stateRepo\Registry\$key" /y | Out-Null',
              '}',
              '',
              'Write-Host "Backing up dynamic directory mapping..."',
              'foreach ($folder in $SyncFolderMap.Keys) {',
              '    $dest = "$stateRepo\Files\$folder"',
              '    if (-not (Test-Path $dest)) { New-Item -Path $dest -ItemType Directory -Force | Out-Null }',
              '    Copy-Item -Path "$($SyncFolderMap[$folder])\*" -Destination $dest -Recurse -Force -ErrorAction SilentlyContinue',
              '}',
              '',
              '# --- 2. DATABASE (SOURCE CONTROL) SYNC ---',
              'Write-Host "Committing and Pushing to Database (GitHub)..."',
              'git add Registry/*.reg',
              'git add Files/*',
              'if (git status --porcelain) {',
              '    git commit -m "Manual Backup $(Get-Date -Format ''HH:mm:ss'')"',
              '    git push origin main',
              '    Write-Host "Backup Sent! You can close this window." -ForegroundColor Cyan',
              '} else {',
              '    Write-Host "No changes detected. Backup skipped." -ForegroundColor Yellow',
              '}',
              'Start-Sleep -Seconds 5'
          )
          $backupScript | Out-File -FilePath "C:\state-repo\Force-Backup.ps1" -Encoding UTF8

          # 2. MANUAL RESTORE SCRIPT
          $restoreScript = $elevationCheck + $DataMaps + @(
              'Write-Host "Forcing Manual Restore..." -ForegroundColor Yellow',
              'Set-Location $stateRepo',
              '',
              '# --- 1. DATABASE (SOURCE CONTROL) SYNC ---',
              'Write-Host "Pulling latest state from Database (GitHub)..."',
              'git reset --hard HEAD',
              'git pull origin main --rebase',
              '',
              '# --- 2. APPLY STATE ---',
              'Write-Host "Restoring physical assets..."',
              'foreach ($folder in $SyncFolderMap.Keys) {',
              '    if (Test-Path "$stateRepo\Files\$folder") {',
              '        Copy-Item -Path "$stateRepo\Files\$folder\*" -Destination $SyncFolderMap[$folder] -Recurse -Force -ErrorAction SilentlyContinue',
              '    }',
              '}',
              '',
              'Write-Host "Applying registry map..."',
              'if (Test-Path "$stateRepo\Registry") {',
              '    Get-ChildItem -Path "$stateRepo\Registry" -Filter "*.reg" | ForEach-Object { ',
              '        $content = Get-Content $_.FullName',
              '        $content = $content -replace "HKEY_CURRENT_USER", "HKEY_USERS\$sid"',
              '        $content | Out-File -FilePath $_.FullName -Encoding Unicode',
              '        Start-Process -FilePath "reg.exe" -ArgumentList "import `"$($_.FullName)`"" -Wait',
              '    }',
              '    ',
              '    Write-Host "Invoking Desktop Window Manager (Theme Engine)..."',
              '    try {',
              '        $regKey =[Microsoft.Win32.Registry]::Users.OpenSubKey("$sid\Software\Microsoft\Windows\CurrentVersion\Themes")',
              '        if ($regKey) {',
              '            $themePath = $regKey.GetValue("CurrentTheme")',
              '            if ($themePath -and (Test-Path $themePath)) {',
              '                Start-Process -FilePath $themePath',
              '                Start-Sleep -Seconds 3',
              '                Stop-Process -Name "SystemSettings" -Force -ErrorAction SilentlyContinue',
              '            }',
              '        }',
              '    } catch { Write-Host "Failed to invoke theme automatically." }',
              '    ',
              '    Write-Host "Restarting Explorer to finalize UI elements..."',
              '    Stop-Process -Name explorer -Force',
              '    Write-Host "Restore Complete! You can close this window." -ForegroundColor Cyan',
              '} else {',
              '    Write-Host "No registry backup found in repository!" -ForegroundColor Red',
              '}',
              'Start-Sleep -Seconds 5'
          )
          $restoreScript | Out-File -FilePath "C:\state-repo\Force-Restore.ps1" -Encoding UTF8

          # 3. BACKGROUND TELEMETRY AGENT
          $syncScript = @(
              'if ($env:USERNAME -ne "cardersparadox") { exit }',
              '$ErrorActionPreference = ''SilentlyContinue''',
              '$logFile = "C:\state-repo\Logs\SyncAgent.log"',
              'if (-not (Test-Path "C:\state-repo\Logs")) { New-Item -Path "C:\state-repo\Logs" -ItemType Directory -Force | Out-Null }',
              'function Write-Log { param([string]$Message); $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"; "[$timestamp] $Message" | Out-File -FilePath $logFile -Append -Encoding UTF8 }',
              '',
              'while (-not (Get-Process -Name explorer -ErrorAction SilentlyContinue)) { Start-Sleep -Seconds 1 }',
              'Copy-Item "C:\state-repo\Force-Backup.ps1" "$env:USERPROFILE\Desktop\Force-Backup.ps1" -Force',
              'Copy-Item "C:\state-repo\Force-Restore.ps1" "$env:USERPROFILE\Desktop\Force-Restore.ps1" -Force'
          ) + $DataMaps + @(
              'Write-Log "=== AGENT STARTED: $sid ==="',
              '$restoredFlag = "$env:TEMP\registry_restored.flag"',
              '',
              '# INITIAL AUTO-RESTORE ON LOGIN',
              'if (-not (Test-Path $restoredFlag)) {',
              '    foreach ($folder in $SyncFolderMap.Keys) {',
              '        if (Test-Path "$stateRepo\Files\$folder") { Copy-Item -Path "$stateRepo\Files\$folder\*" -Destination $SyncFolderMap[$folder] -Recurse -Force -ErrorAction SilentlyContinue }',
              '    }',
              '    if (Test-Path "$stateRepo\Registry") {',
              '        Write-Log "Found backup. Restoring..."',
              '        Get-ChildItem -Path "$stateRepo\Registry" -Filter "*.reg" | ForEach-Object { ',
              '            $content = Get-Content $_.FullName',
              '            $content = $content -replace "HKEY_CURRENT_USER", "HKEY_USERS\$sid"',
              '            $content | Out-File -FilePath $_.FullName -Encoding Unicode',
              '            Start-Process -FilePath "reg.exe" -ArgumentList "import `"$($_.FullName)`"" -Wait',
              '        }',
              '        try {',
              '            $regKey =[Microsoft.Win32.Registry]::Users.OpenSubKey("$sid\Software\Microsoft\Windows\CurrentVersion\Themes")',
              '            if ($regKey) {',
              '                $themePath = $regKey.GetValue("CurrentTheme")',
              '                if ($themePath -and (Test-Path $themePath)) {',
              '                    Start-Process -FilePath $themePath',
              '                    Start-Sleep -Seconds 3',
              '                    Stop-Process -Name "SystemSettings" -Force -ErrorAction SilentlyContinue',
              '                }',
              '            }',
              '        } catch { Write-Log "Theme invoke failed." }',
              '        Stop-Process -Name explorer -Force',
              '        Write-Log "Restoration Complete."',
              '    }',
              '    New-Item -Path $restoredFlag -ItemType File | Out-Null',
              '}',
              '',
              '# INFINITE SYNC LOOP',
              'while ($true) {',
              '    Set-Location $stateRepo',
              '    git config user.name "RDP Sync Agent"',
              '    git config user.email "agent@rdp.local"',
              '    git pull origin main --rebase --quiet',
              '    ',
              '    if (-not (Test-Path "$stateRepo\Registry")) { New-Item -Path "$stateRepo\Registry" -ItemType Directory -Force | Out-Null }',
              '    if (-not (Test-Path "$stateRepo\Files")) { New-Item -Path "$stateRepo\Files" -ItemType Directory -Force | Out-Null }',
              '    ',
              '    foreach ($key in $SyncRegistryMap.Keys) { reg export "HKEY_USERS\$sid\$($SyncRegistryMap[$key])" "$stateRepo\Registry\$key" /y | Out-Null }',
              '    foreach ($folder in $SyncFolderMap.Keys) {',
              '        $dest = "$stateRepo\Files\$folder"',
              '        if (-not (Test-Path $dest)) { New-Item -Path $dest -ItemType Directory -Force | Out-Null }',
              '        Copy-Item -Path "$($SyncFolderMap[$folder])\*" -Destination $dest -Recurse -Force -ErrorAction SilentlyContinue',
              '    }',
              '    ',
              '    git add Registry/*.reg',
              '    git add Files/*',
              '    if (git status --porcelain) {',
              '        Write-Log "SETTINGS CHANGED. Committing..."',
              '        git commit -m "Auto-save Settings $(Get-Date -Format ''HH:mm:ss'')" --quiet',
              '        git push origin main --quiet',
              '        Write-Log "Push Complete."',
              '    } else { Write-Log "No setting changes detected." }',
              '    ',
              '    Start-Sleep -Seconds 300',
              '}'
          )
          $syncScript | Out-File -FilePath $agentPath -Encoding UTF8

          # 4. REGISTER TASK WITH SYSTEM-LEVEL PRIVILEGES
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -WindowStyle Hidden -File `"$agentPath`""
          $trigger = New-ScheduledTaskTrigger -AtLogOn
          $principal = New-ScheduledTaskPrincipal -GroupId "BUILTIN\Administrators" -RunLevel Highest
          Register-ScheduledTask -TaskName "RDPStateSync" -Action $action -Trigger $trigger -Principal $principal -Force | Out-Null
          if (Test-Path "C:\state-repo\Logs\*.log") { Remove-Item "C:\state-repo\Logs\*.log" -Force }
          Write-Host "Bulletproof Agent Registered."

      - name: Install and Connect Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "$env:TEMP\tailscale.exe"
          Start-Process -FilePath "$env:TEMP\tailscale.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="cardersparadox"
          $tsIP = $null; $retries = 0
          while (-not $tsIP -and $retries -lt 12) {
              $tsIP = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
              Start-Sleep -Seconds 5; $retries++
          }
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Maintain Runner Session (Live Logs)
        shell: powershell
        run: |
          Write-Host "================ RDP ACCESS ================"
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "Username: cardersparadox"
          Write-Host "Password: Carding.Git!2024"
          Write-Host "============================================"
          Write-Host "Live logs will appear below ONLY after you log in."
          Write-Host "-----------------------------------------------------------------------------------"
          $logFile = "C:\state-repo\Logs\SyncAgent.log"
          $endTime = (Get-Date).AddMinutes(350)
          $lastPosition = 0
          while ((Get-Date) -lt $endTime) {
              if (Test-Path $logFile) {
                  $file = Get-Item $logFile
                  if ($file.Length -gt $lastPosition) {
                      $fs =[System.IO.FileStream]::new($logFile, [System.IO.FileMode]::Open,[System.IO.FileAccess]::Read, [System.IO.FileShare]::ReadWrite)
                      $fs.Seek($lastPosition,[System.IO.SeekOrigin]::Begin) | Out-Null
                      $reader =[System.IO.StreamReader]::new($fs)
                      while (-not $reader.EndOfStream) { Write-Host $reader.ReadLine() }
                      $lastPosition = $fs.Position
                      $reader.Close(); $fs.Close()
                  }
              }
              Start-Sleep -Seconds 5
          }

      - name: Emergency Backup on Cancellation/Timeout
        if: always()
        shell: powershell
        run: |
          Write-Host "=== EMERGENCY TEARDOWN ==="
          $stateRepo = 'C:\state-repo'
          if (-not (Test-Path $stateRepo)) { exit 0 }
          
          # --- 0. NEUTRALIZE CONCURRENCY & LOCKS ---
          Write-Host "Neutralizing Background Agents & Git Locks..."
          Unregister-ScheduledTask -TaskName "RDPStateSync" -Confirm:$false -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          if (Test-Path "$stateRepo\.git\index.lock") { Remove-Item "$stateRepo\.git\index.lock" -Force -ErrorAction SilentlyContinue }

          try {
              $targetUser = "cardersparadox"
              $userDir = "C:\Users\$targetUser"
              $User = New-Object System.Security.Principal.NTAccount($targetUser)
              $sid = $User.Translate([System.Security.Principal.SecurityIdentifier]).value
              
              if (Test-Path "Registry::HKEY_USERS\$sid") {
                  Write-Host "Saving final state for SID: $sid"
                  Set-Location $stateRepo
                  git config user.name "Emergency Agent"
                  git config user.email "agent@rdp.local"
                  
                  # --- 1. CAPTURE FINAL STATE VIA DYNAMIC MAPS ---
                  # These maps ensure "room for upgrades" across all scenarios.
                  $SyncRegistryMap = @{
                      "Themes.reg"           = "Software\Microsoft\Windows\CurrentVersion\Themes"
                      "ExplorerAdvanced.reg" = "Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced"
                      "StuckRects3.reg"      = "Software\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3"
                      "DWM.reg"              = "Software\Microsoft\Windows\DWM"
                      "Desktop.reg"          = "Control Panel\Desktop"
                  }
                  $SyncFolderMap = @{
                      "LocalAppDataThemes" = "$userDir\AppData\Local\Microsoft\Windows\Themes"
                      "AppDataThemes"      = "$userDir\AppData\Roaming\Microsoft\Windows\Themes"
                  }
                  
                  if (-not (Test-Path "$stateRepo\Registry")) { New-Item -Path "$stateRepo\Registry" -ItemType Directory -Force | Out-Null }
                  if (-not (Test-Path "$stateRepo\Files")) { New-Item -Path "$stateRepo\Files" -ItemType Directory -Force | Out-Null }
                  
                  foreach ($key in $SyncRegistryMap.Keys) {
                      reg export "HKEY_USERS\$sid\$($SyncRegistryMap[$key])" "$stateRepo\Registry\$key" /y | Out-Null
                  }
                  foreach ($folder in $SyncFolderMap.Keys) {
                      $dest = "$stateRepo\Files\$folder"
                      if (-not (Test-Path $dest)) { New-Item -Path $dest -ItemType Directory -Force | Out-Null }
                      Copy-Item -Path "$($SyncFolderMap[$folder])\*" -Destination $dest -Recurse -Force -ErrorAction SilentlyContinue
                  }

                  # --- 2. DATABASE (SOURCE CONTROL) SYNC ---
                  # Re-ordered: Add -> Commit Locally -> Pull (Merge) -> Push
                  # Uses --quiet to suppress Git stderr streams and avoid false GitHub Action Exit Codes.
                  git add Registry/*.reg
                  git add Files/*
                  
                  if (git status --porcelain) {
                      Write-Host "Changes detected, committing locally..."
                      git commit -m "Emergency Save (VM Shutdown)" --quiet
                  } else { 
                      Write-Host "No local changes detected." 
                  }
                  
                  Write-Host "Synchronizing with Database (Remote Repository)..."
                  git pull origin main --rebase --quiet
                  git push origin main --quiet
                  
                  if ($LASTEXITCODE -eq 0) {
                      Write-Host "Emergency Backup Complete and Successful."
                  } else {
                      Write-Host "Warning: Remote synchronization failed or reported exit code $LASTEXITCODE."
                  }
              }
          } catch { Write-Host "Error: $($_.Exception.Message)" }
