name: RDP-Static-Persistent-Final

on:
  workflow_dispatch:

permissions:
  contents: write  # Crucial: Grants the native GITHUB_TOKEN permission to push state logs

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Clone Existing Tailwind Repository
        shell: powershell
        env:
          MY_PAT: ${{ secrets.GH_PAT }}
          NATIVE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Intelligent fallback: Use custom GH_PAT if it exists, otherwise fall back to native repo token.
          $token = $env:MY_PAT
          if ([string]::IsNullOrWhiteSpace($token)) {
              Write-Host "GH_PAT secret is empty or missing. Falling back to built-in GITHUB_TOKEN..."
              $token = $env:NATIVE_TOKEN
          }
          
          if ([string]::IsNullOrWhiteSpace($token)) {
              Write-Error "CRITICAL FAILURE: Both GH_PAT and GITHUB_TOKEN are empty. Cannot authenticate to GitHub."
              exit 1
          }

          $repoUrl = "https://x-access-token:$token@github.com/cradixo/tailwind-rdp.git"
          Write-Host "Initiating Git Clone sequence..."
          git clone $repoUrl C:\state-repo
          
          if (-not (Test-Path "C:\state-repo\.git")) {
            Write-Error "Failed to clone state repository. Authentication was rejected."
            exit 1
          }
          Write-Host "Repository cloned successfully."

          # CRITICAL FIX: Grant explicit global read/write permissions to bypass UAC file restrictions
          icacls "C:\state-repo" /grant "Everyone:(OI)(CI)F" /T | Out-Null
          Write-Host "NTFS Permissions elevated for repository path."

      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      - name: Create RDP User
        run: |
          $username = "cardersparadox"
          $password = "Carding.Git!2024"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

      - name: Deploy High-Privilege Telemetry Agent
        run: |
          $agentPath = "C:\state-repo\StateSync.ps1"
          
          $syncScript = @(
              '$ErrorActionPreference = ''SilentlyContinue''',
              '$stateRepo = ''C:\state-repo''',
              '$logDir = "$stateRepo\Logs"',
              '$logFile = "$logDir\SyncAgent.log"',
              '$restoredFlag = "$env:TEMP\registry_restored.flag"',
              '',
              'if (-not (Test-Path $logDir)) { New-Item -Path $logDir -ItemType Directory -Force | Out-Null }',
              '',
              'function Write-Log {',
              '    param([string]$Message)',
              '    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"',
              '    $logLine = "[$timestamp] $Message"',
              '    Out-File -FilePath $logFile -InputObject $logLine -Append -Encoding UTF8',
              '}',
              '',
              '# Safety Guard: Ensure we are in the correct user context',
              'if ($env:USERNAME -ne "cardersparadox") {',
              '    Write-Log "CRITICAL: Script started in wrong user context ($env:USERNAME). Aborting to prevent corruption."',
              '    exit',
              '}',
              '',
              '# Wait for Windows Explorer to fully load (DWM) before attempting restore',
              'while (-not (Get-Process -Name explorer -ErrorAction SilentlyContinue)) {',
              '    Start-Sleep -Seconds 2',
              '}',
              '',
              '# Calculate the precise RDP SID',
              '$User = New-Object System.Security.Principal.NTAccount("cardersparadox")',
              '$sid = $User.Translate([System.Security.Principal.SecurityIdentifier]).value',
              '',
              'Write-Log "========================================"',
              'Write-Log "Sync Agent Initialized. Mapped Target RDP SID: $sid"',
              'Write-Log "========================================"',
              '',
              'if (-not (Test-Path $restoredFlag)) {',
              '    if (Test-Path "$stateRepo\Registry") {',
              '        Write-Log "*** RESTORATION SEQUENCE STARTED ***"',
              '        Write-Log "Found existing Registry backups. Applying configurations..."',
              '        Get-ChildItem -Path "$stateRepo\Registry" -Filter "*.reg" | ForEach-Object { ',
              '            # Dynamically inject the correct SID into the text file',
              '            $regContent = Get-Content $_.FullName',
              '            $regContent = $regContent -replace "HKEY_CURRENT_USER", "HKEY_USERS\$sid"',
              '            $regContent | Out-File -FilePath $_.FullName -Encoding Unicode',
              '            ',
              '            $importResult = Start-Process -FilePath "reg.exe" -ArgumentList "import `"$($_.FullName)`"" -Wait -PassThru',
              '            Write-Log "Imported $($_.Name) with exit code: $($importResult.ExitCode)"',
              '        }',
              '        Write-Log "Restarting Windows Explorer to instantly apply visual changes."',
              '        Stop-Process -Name explorer -Force',
              '        Write-Log "*** RESTORATION COMPLETED SUCCESSFULLY ***"',
              '    } else {',
              '        Write-Log "No existing Registry folder found. Proceeding with fresh configuration."',
              '    }',
              '    New-Item -Path $restoredFlag -ItemType File | Out-Null',
              '}',
              '',
              'while ($true) {',
              '    Write-Log "Initiating routine 1-minute sync and export cycle..."',
              '    Set-Location $stateRepo',
              '    git config user.name "RDP Sync Agent"',
              '    git config user.email "agent@rdp.local"',
              '    git config --global core.safecrlf false',
              '    ',
              '    # Pulled to the top to prevent dirty rebase warnings',
              '    Write-Log "Pulling latest remote changes (rebase)..."',
              '    $pullOutput = git pull origin main --rebase 2>&1',
              '    Write-Log "Git Pull Output: $pullOutput"',
              '    ',
              '    New-Item -Path "$stateRepo\Registry" -ItemType Directory -Force | Out-Null',
              '    ',
              '    # Export strictly from the calculated mathematical SID',
              '    reg export "HKEY_USERS\$sid\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" "$stateRepo\Registry\Personalize.reg" /y',
              '    reg export "HKEY_USERS\$sid\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" "$stateRepo\Registry\ExplorerAdvanced.reg" /y',
              '    reg export "HKEY_USERS\$sid\Software\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3" "$stateRepo\Registry\StuckRects3.reg" /y',
              '    reg export "HKEY_USERS\$sid\Software\Microsoft\Windows\DWM" "$stateRepo\Registry\DWM.reg" /y',
              '    reg export "HKEY_USERS\$sid\Control Panel\Desktop" "$stateRepo\Registry\Desktop.reg" /y',
              '    Write-Log "Native cross-profile registry keys exported successfully."',
              '    ',
              '    $status = git status --porcelain',
              '    if ($status) {',
              '        Write-Log "Changes detected. Committing..."',
              '        git add . ',
              '        $commitMsg = "Auto-save Windows UI & Telemetry $(Get-Date -Format ''yyyy-MM-dd HH:mm:ss'')" ',
              '        git commit -m "$commitMsg" 2>&1 | Out-Null',
              '        ',
              '        Write-Log "Pushing to GitHub..."',
              '        $pushOutput = git push origin main 2>&1',
              '        Write-Log "Git Push Output: $pushOutput"',
              '    }',
              '    ',
              '    Write-Log "Cycle complete. Sleeping for 1 minute before next sync..."',
              '    Start-Sleep -Seconds 60',
              '}'
          )
          $syncScript | Out-File -FilePath $agentPath -Encoding UTF8
          
          # CRITICAL FIX: Register Task strictly for the 'cardersparadox' identity to kill Ghost Runs
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -WindowStyle Hidden -File `"$agentPath`""
          $trigger = New-ScheduledTaskTrigger -AtLogOn -User "cardersparadox"
          $password = "Carding.Git!2024"
          Register-ScheduledTask -TaskName "RDPStateSync" -Action $action -Trigger $trigger -RunLevel Highest -User "cardersparadox" -Password $password -Force | Out-Null
          Write-Host "Elevated telemetry agent successfully registered for user: cardersparadox"

      - name: Install and Connect Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "$env:TEMP\tailscale.exe"
          Start-Process -FilePath "$env:TEMP\tailscale.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="cardersparadox"
          
          $tsIP = $null; $retries = 0
          while (-not $tsIP -and $retries -lt 12) {
              $tsIP = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
              Start-Sleep -Seconds 5; $retries++
          }
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Maintain Runner Session (Live Logs)
        shell: powershell
        run: |
          Write-Host "================ RDP ACCESS ================"
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "Username: cardersparadox"
          Write-Host "Password: Carding.Git!2024"
          Write-Host "============================================"
          Write-Host "Connecting via RDP will INSTANTLY launch the invisible Sync & Logging Agent."
          Write-Host "Check the console below for LIVE telemetry streaming directly from your RDP session..."
          Write-Host "-----------------------------------------------------------------------------------"
          
          $logFile = "C:\state-repo\Logs\SyncAgent.log"
          $endTime = (Get-Date).AddMinutes(350)
          $lastPosition = 0
          
          # Dynamic Non-Blocking File Stream Reader
          while ((Get-Date) -lt $endTime) {
              if (Test-Path $logFile) {
                  $file = Get-Item $logFile
                  if ($file.Length -gt $lastPosition) {
                      # Open with ReadWrite share to completely avoid locking out the background agent
                      $fs = [System.IO.FileStream]::new($logFile, [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read, [System.IO.FileShare]::ReadWrite)
                      $fs.Seek($lastPosition, [System.IO.SeekOrigin]::Begin) | Out-Null
                      $reader = [System.IO.StreamReader]::new($fs)
                      
                      while (-not $reader.EndOfStream) {
                          Write-Host $reader.ReadLine()
                      }
                      
                      $lastPosition = $fs.Position
                      $reader.Close()
                      $fs.Close()
                  }
              }
              Start-Sleep -Seconds 5
          }

      - name: Emergency Backup on Cancellation/Timeout
        if: always()
        shell: powershell
        run: |
          Write-Host "================ EMERGENCY TEARDOWN ================"
          Write-Host "Job concluded or was manually cancelled. Performing emergency background backup..."
          $stateRepo = 'C:\state-repo'
          
          if (-not (Test-Path $stateRepo)) {
              Write-Host "State repository was never cloned. Skipping emergency backup."
              exit 0
          }
          
          try {
              $User = New-Object System.Security.Principal.NTAccount("cardersparadox")
              $sid = $User.Translate([System.Security.Principal.SecurityIdentifier]).value
              
              if (Test-Path "Registry::HKEY_USERS\$sid") {
                  Write-Host "Target user hive (SID: $sid) is actively loaded. Exporting final state..."
                  New-Item -Path "$stateRepo\Registry" -ItemType Directory -Force | Out-Null
                  
                  Set-Location $stateRepo
                  git config user.name "Emergency Sync Agent"
                  git config user.email "agent@rdp.local"
                  git config --global core.safecrlf false
                  
                  # Git pull executes BEFORE export to eliminate rebase warnings
                  git pull origin main --rebase
                  
                  reg export "HKEY_USERS\$sid\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" "$stateRepo\Registry\Personalize.reg" /y
                  reg export "HKEY_USERS\$sid\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" "$stateRepo\Registry\ExplorerAdvanced.reg" /y
                  reg export "HKEY_USERS\$sid\Software\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3" "$stateRepo\Registry\StuckRects3.reg" /y
                  reg export "HKEY_USERS\$sid\Software\Microsoft\Windows\DWM" "$stateRepo\Registry\DWM.reg" /y
                  reg export "HKEY_USERS\$sid\Control Panel\Desktop" "$stateRepo\Registry\Desktop.reg" /y
                  
                  Write-Host "Registry successfully extracted cross-profile."
                  
                  git add .
                  $status = git status --porcelain
                  if ($status) {
                      $commitMsg = "Emergency Auto-save Windows UI $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
                      git commit -m "$commitMsg"
                      git push origin main
                      Write-Host "Emergency backup successfully pushed to GitHub."
                  } else {
                      Write-Host "No registry changes detected during emergency scan. Repository is up-to-date."
                  }
              } else {
                  Write-Host "User hive not loaded. User likely logged out manually before cancellation."
              }
          } catch {
              Write-Host "Error calculating SID: $($_.Exception.Message)"
          }
          Write-Host "===================================================="
