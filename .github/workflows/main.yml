name: RDP-Static-Persistent-Final

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  RDP_USER: RunnerAdmin
  RDP_PASS: SecureP@ssw0rd!2024

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    - name: Clone State Repo
      shell: powershell
      run: |
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} C:\state-repo
        icacls C:\state-repo /grant Everyone:(OI)(CI)F /T


    - name: Enable RDP
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389


    - name: Create User
      shell: powershell
      run: |
        $pass = ConvertTo-SecureString "${{ env.RDP_PASS }}" -AsPlainText -Force
        New-LocalUser -Name "${{ env.RDP_USER }}" -Password $pass -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "${{ env.RDP_USER }}"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "${{ env.RDP_USER }}"


    - name: Deploy Persistence System
      shell: powershell
      run: |

        $repo = "C:\state-repo"
        $user = "${{ env.RDP_USER }}"
        $desktop = "C:\Users\$user\Desktop"

        New-Item $repo -ItemType Directory -Force | Out-Null

        # Backup script
        @'
Set-Location C:\state-repo
git add .
if (git status --porcelain) {
 git commit -m "Backup"
 git push
}
'@ | Out-File "$repo\ForceBackup.ps1" -Encoding UTF8


        # Restore script
        @'
Set-Location C:\state-repo
git pull
Stop-Process explorer -Force
'@ | Out-File "$repo\ForceRestore.ps1" -Encoding UTF8


        # Toggle script
        @'
$flag="C:\state-repo\idle_disabled.flag"
if(Test-Path $flag){
 Remove-Item $flag
}else{
 New-Item $flag -ItemType File
}
'@ | Out-File "$repo\ToggleRuntime.ps1" -Encoding UTF8


        # Idle Monitor
        @'
Add-Type @"
using System;
using System.Runtime.InteropServices;
public class Idle {
 [DllImport("user32.dll")]
 public static extern bool GetLastInputInfo(ref LASTINPUTINFO plii);
 public struct LASTINPUTINFO { public uint cbSize; public uint dwTime; }
 public static uint Time() {
  LASTINPUTINFO li=new LASTINPUTINFO();
  li.cbSize=(uint)System.Runtime.InteropServices.Marshal.SizeOf(li);
  GetLastInputInfo(ref li);
  return ((uint)Environment.TickCount-li.dwTime);
 }
}
"@

while($true){
 Start-Sleep 10
 if(Test-Path C:\state-repo\idle_disabled.flag){continue}
 if([Idle]::Time() -gt 900000){
  New-Item C:\state-repo\end.flag -Force
  exit
 }
}
'@ | Out-File "$repo\IdleMonitor.ps1" -Encoding UTF8


        # Agent
        @'
$user = $env:USERNAME
$desktop = "C:\Users\$user\Desktop"

Copy-Item C:\state-repo\ForceBackup.ps1 $desktop -Force
Copy-Item C:\state-repo\ForceRestore.ps1 $desktop -Force
Copy-Item C:\state-repo\ToggleRuntime.ps1 $desktop -Force

powershell -WindowStyle Hidden -File C:\state-repo\IdleMonitor.ps1

if (!(Test-Path C:\state-repo\restore.flag)) {
 powershell -File C:\state-repo\ForceRestore.ps1
 New-Item C:\state-repo\restore.flag
}

while($true){
 if(Test-Path C:\state-repo\end.flag){
  powershell -File C:\state-repo\ForceBackup.ps1
  exit
 }
 Start-Sleep 5
}
'@ | Out-File "$repo\Agent.ps1" -Encoding UTF8


        # Register scheduled task
        $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle Hidden -File C:\state-repo\Agent.ps1"
        $trigger = New-ScheduledTaskTrigger -AtLogOn
        $principal = New-ScheduledTaskPrincipal -GroupId "BUILTIN\Administrators" -RunLevel Highest

        Register-ScheduledTask -TaskName "PersistenceAgent" -Action $action -Trigger $trigger -Principal $principal -Force


    - name: Install Tailscale
      shell: powershell
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile ts.exe
        Start-Process ts.exe /quiet -Wait
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="${{ env.RDP_USER }}"
        $ip=& "C:\Program Files\Tailscale\tailscale.exe" ip -4
        echo "IP=$ip"
        

    - name: Session Loop
      shell: powershell
      run: |
        while($true){
         if(Test-Path C:\state-repo\end.flag){
          exit
         }
         Start-Sleep 5
        }
