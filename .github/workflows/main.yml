name: Persistent RDP Ultimate

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  RDP_USER: RunnerAdmin
  RDP_PASS: SecureP@ssw0rd!2024

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    - name: Clone persistence repo
      shell: powershell
      run: |
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} C:\state-repo
        icacls C:\state-repo /grant Everyone:(OI)(CI)F /T


    - name: Enable RDP
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389


    - name: Create persistent user
      shell: powershell
      run: |
        $pass=ConvertTo-SecureString "${{ env.RDP_PASS }}" -AsPlainText -Force
        New-LocalUser -Name "${{ env.RDP_USER }}" -Password $pass -AccountNeverExpires
        Add-LocalGroupMember Administrators "${{ env.RDP_USER }}"
        Add-LocalGroupMember "Remote Desktop Users" "${{ env.RDP_USER }}"


    - name: Deploy persistence engine
      shell: powershell
      run: |

        $repo="C:\state-repo"

        mkdir "$repo\Registry" -ea 0
        mkdir "$repo\Files" -ea 0
        mkdir "$repo\InitScripts" -ea 0


        ################################
        # BACKUP SCRIPT
        ################################

        $backup=@(
        '$repo="C:\state-repo"',
        'Set-Location $repo',
        'git add .',
        'if(git status --porcelain){',
        ' git commit -m "Manual backup"',
        ' git push',
        '}'
        )
        $backup | Out-File "$repo\ForceBackup.ps1" -Encoding UTF8


        ################################
        # RESTORE SCRIPT
        ################################

        $restore=@(
        '$repo="C:\state-repo"',
        'Set-Location $repo',
        'git pull',
        'Stop-Process explorer -Force'
        )
        $restore | Out-File "$repo\ForceRestore.ps1"


        ################################
        # RUNTIME TOGGLE SCRIPT
        ################################

        $toggle=@(
        '$flag="C:\state-repo\idle_disabled.flag"',
        'if(Test-Path $flag){',
        ' Remove-Item $flag',
        ' msg * "Runtime auto-shutdown ENABLED"',
        '}',
        'else{',
        ' New-Item $flag -ItemType File',
        ' msg * "Runtime auto-shutdown DISABLED"',
        '}'
        )
        $toggle | Out-File "$repo\ToggleRuntime.ps1"


        ################################
        # INIT SCRIPT EXECUTOR
        ################################

        $init=@(
        '$dir="C:\state-repo\InitScripts"',
        'if(Test-Path $dir){',
        ' Get-ChildItem $dir | ForEach-Object {',
        '  if($_.Extension -eq ".ps1"){powershell -File $_.FullName}',
        '  if($_.Extension -eq ".cmd"){cmd /c $_.FullName}',
        '  if($_.Extension -eq ".bat"){cmd /c $_.FullName}',
        '  if($_.Extension -eq ".py"){python $_.FullName}',
        ' }',
        '}'
        )
        $init | Out-File "$repo\RunInit.ps1"


        ################################
        # IDLE MONITOR
        ################################

        $idle=@(
        'Add-Type -AssemblyName System.Windows.Forms',
        'while($true){',
        ' Start-Sleep 10',
        ' if(Test-Path C:\state-repo\idle_disabled.flag){continue}',
        ' $idle=[System.Windows.Forms.SystemInformation]::IdleTime',
        ' if($idle -gt 900000){',
        '  msg * "Idle detected. Shutdown in 60 seconds."',
        '  Start-Sleep 60',
        '  if($idle -gt 900000){',
        '   New-Item C:\state-repo\end.flag -Force',
        '   exit',
        '  }',
        ' }',
        '}'
        )
        $idle | Out-File "$repo\IdleMonitor.ps1"


        ################################
        # MAIN AGENT
        ################################

        $agent=@(
        '$desktop="C:\Users\$env:USERNAME\Desktop"',
        'Copy-Item C:\state-repo\ForceBackup.ps1 $desktop -Force',
        'Copy-Item C:\state-repo\ForceRestore.ps1 $desktop -Force',
        'Copy-Item C:\state-repo\ToggleRuntime.ps1 $desktop -Force',
        'powershell -WindowStyle Hidden -File C:\state-repo\RunInit.ps1',
        'powershell -WindowStyle Hidden -File C:\state-repo\IdleMonitor.ps1',
        'if(!(Test-Path C:\state-repo\restore.flag)){',
        ' powershell -File C:\state-repo\ForceRestore.ps1',
        ' New-Item C:\state-repo\restore.flag',
        '}',
        'while($true){',
        ' if(Test-Path C:\state-repo\end.flag){',
        '  powershell -File C:\state-repo\ForceBackup.ps1',
        '  exit',
        ' }',
        ' Start-Sleep 5',
        '}'
        )
        $agent | Out-File "$repo\Agent.ps1"


        ################################
        # REGISTER AGENT
        ################################

        $action=New-ScheduledTaskAction -Execute powershell.exe -Argument "-WindowStyle Hidden -File C:\state-repo\Agent.ps1"
        $trigger=New-ScheduledTaskTrigger -AtLogOn
        $principal=New-ScheduledTaskPrincipal -GroupId "BUILTIN\Administrators" -RunLevel Highest

        Register-ScheduledTask -TaskName PersistenceAgent -Action $action -Trigger $trigger -Principal $principal -Force


    - name: Install tailscale
      shell: powershell
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile ts.exe
        Start-Process ts.exe /quiet -Wait
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="${{ env.RDP_USER }}"
        & "C:\Program Files\Tailscale\tailscale.exe" ip -4


    - name: Maintain session
      shell: powershell
      run: |
        while($true){
          if(Test-Path C:\state-repo\end.flag){exit}
          Start-Sleep 5
        }
