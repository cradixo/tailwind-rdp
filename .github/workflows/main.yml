name: RDP-Static-Persistent-Final

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  RDP_USER: ${{ secrets.RDP_USERNAME || 'RunnerAdmin' }}
  RDP_PASS: ${{ secrets.RDP_PASSWORD || 'SecureP@ssw0rd!2024' }}
  SAVE_RUNTIME: ${{ secrets.SAVE_RUNTIME || 'false' }}

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Initialize Distributed State Repository
        shell: powershell
        env:
          DB_PAT: ${{ secrets.BACKUP_DB_PAT }}
          DB_USER: ${{ secrets.BACKUP_DB_USER }}
          DB_REPO: ${{ secrets.BACKUP_DB_REPO }}
          NATIVE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LOCAL_REPO: ${{ github.repository }}
        run: |
          $fallback = $false
          
          # 1. Try Remote DB
          if ([string]::IsNullOrWhiteSpace($env:DB_PAT) -or [string]::IsNullOrWhiteSpace($env:DB_USER) -or [string]::IsNullOrWhiteSpace($env:DB_REPO)) {
              Write-Host "Secrets missing. Using local repo." -ForegroundColor Yellow
              $fallback = $true
          } else {
              $repoUrl = "https://$($env:DB_USER):$($env:DB_PAT)@github.com/$($env:DB_USER)/$($env:DB_REPO).git"
              cmd.exe /c "git clone -q `"$repoUrl`" C:\state-repo 2>nul"
              if ($LASTEXITCODE -ne 0 -or -not (Test-Path "C:\state-repo\.git")) { $fallback = $true }
          }
          
          # 2. Fallback Local DB
          if ($fallback) {
              if (Test-Path "C:\state-repo") { Remove-Item -Path "C:\state-repo" -Recurse -Force -ErrorAction SilentlyContinue }
              $localRepoUrl = "https://x-access-token:$($env:NATIVE_TOKEN)@github.com/$env:LOCAL_REPO.git"
              cmd.exe /c "git clone -q `"$localRepoUrl`" C:\state-repo 2>nul"
          }
          
          if (-not (Test-Path "C:\state-repo\.git")) { Write-Error "Database Init Failed"; exit 1 }
          icacls "C:\state-repo" /grant "Everyone:(OI)(CI)F" /T | Out-Null

      - name: Configure RDP & Firewall
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      - name: Create User Account
        run: |
          $securePass = ConvertTo-SecureString "${{ env.RDP_PASS }}" -AsPlainText -Force
          New-LocalUser -Name "${{ env.RDP_USER }}" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "${{ env.RDP_USER }}"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "${{ env.RDP_USER }}"

      - name: Deploy Robust Manual Tools (Embedded Config)
        shell: powershell
        run: |
          # --- GENERATION CONFIGURATION ---
          # We embed these variables DIRECTLY into the script strings to avoid runtime scope issues.
          
          $CommonHeader = @(
              '# --- SELF-ELEVATION GUARD ---',
              '$currentUser = New-Object Security.Principal.WindowsPrincipal ([Security.Principal.WindowsIdentity]::GetCurrent())',
              'if (-not $currentUser.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {',
              '    Start-Process powershell.exe -Verb RunAs -ArgumentList "-NoProfile -File `"$PSCommandPath`"";',
              '    exit;',
              '}',
              '',
              "# --- CONFIGURATION MAP ---",
              "`$targetUser = '${{ env.RDP_USER }}'",
              '`$stateRepo = "C:\state-repo"',
              '`$userDir = "C:\Users\$targetUser"',
              'try {',
              '    $UserObj = New-Object System.Security.Principal.NTAccount($targetUser)',
              '    $sid = $UserObj.Translate([System.Security.Principal.SecurityIdentifier]).value',
              '} catch { $sid = "UNKNOWN" }',
              '',
              '$SyncRegistryMap = @{',
              '    "Themes.reg"           = "Software\Microsoft\Windows\CurrentVersion\Themes"',
              '    "ExplorerAdvanced.reg" = "Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced"',
              '    "StuckRects3.reg"      = "Software\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3"',
              '    "DWM.reg"              = "Software\Microsoft\Windows\DWM"',
              '    "Desktop.reg"          = "Control Panel\Desktop"',
              '}',
              '',
              '$SyncFolderMap = @{',
              '    "LocalAppDataThemes" = "$userDir\AppData\Local\Microsoft\Windows\Themes"',
              '    "AppDataThemes"      = "$userDir\AppData\Roaming\Microsoft\Windows\Themes"',
              '}'
          )

          # 1. FORCE BACKUP SCRIPT
          $backupScript = $CommonHeader + @(
              '',
              'Write-Host "Initiating Manual Backup..." -ForegroundColor Green',
              'Set-Location $stateRepo',
              'if (-not (Test-Path "$stateRepo\Registry")) { New-Item -Path "$stateRepo\Registry" -ItemType Directory -Force | Out-Null }',
              'if (-not (Test-Path "$stateRepo\Files")) { New-Item -Path "$stateRepo\Files" -ItemType Directory -Force | Out-Null }',
              '',
              'foreach ($key in $SyncRegistryMap.Keys) {',
              '    reg export "HKEY_USERS\$sid\$($SyncRegistryMap[$key])" "$stateRepo\Registry\$key" /y | Out-Null',
              '}',
              '',
              'foreach ($folder in $SyncFolderMap.Keys) {',
              '    $dest = "$stateRepo\Files\$folder"',
              '    if (-not (Test-Path $dest)) { New-Item -Path $dest -ItemType Directory -Force | Out-Null }',
              '    Copy-Item -Path "$($SyncFolderMap[$folder])\*" -Destination $dest -Recurse -Force -ErrorAction SilentlyContinue',
              '}',
              '',
              'git add Registry/*.reg; git add Files/*',
              'if (git status --porcelain) {',
              '    git commit -m "Manual Backup $(Get-Date -Format ''HH:mm:ss'')"',
              '    git push origin main',
              '    Write-Host "Backup Successful." -ForegroundColor Cyan',
              '} else { Write-Host "No changes to save." -ForegroundColor Yellow }',
              'Start-Sleep -Seconds 3'
          )
          $backupScript | Out-File -FilePath "C:\state-repo\Force-Backup.ps1" -Encoding UTF8

          # 2. FORCE RESTORE SCRIPT (FIXED: Kill Explorer FIRST)
          $restoreScript = $CommonHeader + @(
              '',
              'Write-Host "Initiating Manual Restore..." -ForegroundColor Yellow',
              'Set-Location $stateRepo',
              'git reset --hard HEAD; git pull origin main --rebase',
              '',
              '# --- CRITICAL: UNLOCK FILES ---',
              'Write-Host "Closing Explorer to unlock files..."',
              'Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue',
              'Start-Sleep -Seconds 2',
              '',
              '# --- RESTORE FILES ---',
              'foreach ($folder in $SyncFolderMap.Keys) {',
              '    if (Test-Path "$stateRepo\Files\$folder") {',
              '        Write-Host "Restoring $folder..."',
              '        Copy-Item -Path "$stateRepo\Files\$folder\*" -Destination $SyncFolderMap[$folder] -Recurse -Force -ErrorAction SilentlyContinue',
              '    }',
              '}',
              '',
              '# --- RESTORE REGISTRY ---',
              'if (Test-Path "$stateRepo\Registry") {',
              '    Get-ChildItem -Path "$stateRepo\Registry" -Filter "*.reg" | ForEach-Object { ',
              '        $content = Get-Content $_.FullName',
              '        $content = $content -replace "HKEY_CURRENT_USER", "HKEY_USERS\$sid"',
              '        $content | Out-File -FilePath $_.FullName -Encoding Unicode',
              '        Start-Process -FilePath "reg.exe" -ArgumentList "import `"$($_.FullName)`"" -Wait',
              '    }',
              '}',
              '',
              '# --- RESTART UI ---',
              'Write-Host "Restarting User Interface..."',
              'Start-Process explorer.exe',
              'Write-Host "Restoration Complete." -ForegroundColor Cyan',
              'Start-Sleep -Seconds 5'
          )
          $restoreScript | Out-File -FilePath "C:\state-repo\Force-Restore.ps1" -Encoding UTF8

          # 3. PUBLIC DESKTOP DEPLOYMENT
          $publicDesktop = [Environment]::GetFolderPath("CommonDesktopDirectory")
          Copy-Item "C:\state-repo\Force-Backup.ps1" "$publicDesktop\Force-Backup.ps1" -Force
          Copy-Item "C:\state-repo\Force-Restore.ps1" "$publicDesktop\Force-Restore.ps1" -Force

      - name: Deploy Background Sync Daemon (StateSync.ps1)
        shell: powershell
        run: |
          # The Daemon uses a slightly different logic (Check if Explorer exists -> Restore -> Loop)
          # We embed the variables here too for safety.
          $daemonScript = @(
              "`$targetUser = '${{ env.RDP_USER }}'",
              '`$stateRepo = "C:\state-repo"',
              '`$userDir = "C:\Users\$targetUser"',
              'if ($env:USERNAME -ne $targetUser) { exit }',
              '$ErrorActionPreference = "SilentlyContinue"',
              '$logDir = "C:\state-repo\Logs"; if (-not (Test-Path $logDir)) { New-Item -Path $logDir -ItemType Directory -Force | Out-Null }',
              'function Write-Log { param([string]$Message); "[$((Get-Date).ToString("yyyy-MM-dd HH:mm:ss"))] $Message" | Out-File -FilePath "$logDir\SyncDaemon.log" -Append -Encoding UTF8 }',
              '',
              '# Wait for Login',
              'while (-not (Get-Process -Name explorer -ErrorAction SilentlyContinue)) { Start-Sleep -Seconds 1 }',
              '',
              'try {',
              '    $UserObj = New-Object System.Security.Principal.NTAccount($targetUser)',
              '    $sid = $UserObj.Translate([System.Security.Principal.SecurityIdentifier]).value',
              '} catch { $sid = "UNKNOWN" }',
              '',
              '$SyncRegistryMap = @{',
              '    "Themes.reg"           = "Software\Microsoft\Windows\CurrentVersion\Themes"',
              '    "ExplorerAdvanced.reg" = "Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced"',
              '    "StuckRects3.reg"      = "Software\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3"',
              '    "DWM.reg"              = "Software\Microsoft\Windows\DWM"',
              '    "Desktop.reg"          = "Control Panel\Desktop"',
              '}',
              '$SyncFolderMap = @{',
              '    "LocalAppDataThemes" = "$userDir\AppData\Local\Microsoft\Windows\Themes"',
              '    "AppDataThemes"      = "$userDir\AppData\Roaming\Microsoft\Windows\Themes"',
              '}',
              '',
              '# Initial Restore (Once per boot)',
              '$restoredFlag = "$env:TEMP\registry_restored.flag"',
              'if (-not (Test-Path $restoredFlag)) {',
              '    Write-Log "Performing Logon Restoration..."',
              '    foreach ($folder in $SyncFolderMap.Keys) { if (Test-Path "$stateRepo\Files\$folder") { Copy-Item -Path "$stateRepo\Files\$folder\*" -Destination $SyncFolderMap[$folder] -Recurse -Force } }',
              '    if (Test-Path "$stateRepo\Registry") {',
              '        Get-ChildItem -Path "$stateRepo\Registry" -Filter "*.reg" | ForEach-Object { ',
              '            $content = Get-Content $_.FullName; $content = $content -replace "HKEY_CURRENT_USER", "HKEY_USERS\$sid"',
              '            $content | Out-File -FilePath $_.FullName -Encoding Unicode',
              '            Start-Process -FilePath "reg.exe" -ArgumentList "import `"$($_.FullName)`"" -Wait',
              '        }',
              '        # We do NOT kill explorer here to avoid login loop crashes, we just reload reg',
              '    }',
              '    New-Item -Path $restoredFlag -ItemType File | Out-Null',
              '}',
              '',
              '# Persistence Loop',
              'while ($true) {',
              '    # Ensure tools are on Desktop',
              '    $publicDesktop = [Environment]::GetFolderPath("CommonDesktopDirectory")',
              '    $tools = @("Force-Backup.ps1", "Force-Restore.ps1", "Toggle-AutoShutdown.ps1")',
              '    foreach ($tool in $tools) { if (Test-Path "C:\state-repo\$tool") { Copy-Item "C:\state-repo\$tool" "$publicDesktop\$tool" -Force } }',
              '',
              '    # Sync Logic',
              '    Set-Location $stateRepo',
              '    git config user.name "RDP Sync Daemon"; git config user.email "daemon@rdp.local"',
              '    git pull origin main --rebase --quiet',
              '    ',
              '    if (-not (Test-Path "$stateRepo\Registry")) { New-Item -Path "$stateRepo\Registry" -ItemType Directory -Force | Out-Null }',
              '    if (-not (Test-Path "$stateRepo\Files")) { New-Item -Path "$stateRepo\Files" -ItemType Directory -Force | Out-Null }',
              '    ',
              '    foreach ($key in $SyncRegistryMap.Keys) { reg export "HKEY_USERS\$sid\$($SyncRegistryMap[$key])" "$stateRepo\Registry\$key" /y | Out-Null }',
              '    foreach ($folder in $SyncFolderMap.Keys) {',
              '        $dest = "$stateRepo\Files\$folder"',
              '        if (-not (Test-Path $dest)) { New-Item -Path $dest -ItemType Directory -Force | Out-Null }',
              '        Copy-Item -Path "$($SyncFolderMap[$folder])\*" -Destination $dest -Recurse -Force -ErrorAction SilentlyContinue',
              '    }',
              '    ',
              '    git add Registry/*.reg; git add Files/*',
              '    if (git status --porcelain) {',
              '        git commit -m "Auto-save State $(Get-Date -Format "HH:mm:ss")" --quiet',
              '        git push origin main --quiet',
              '        Write-Log "Synced."',
              '    }',
              '    Start-Sleep -Seconds 300',
              '}'
          )
          $daemonScript | Out-File -FilePath "C:\state-repo\StateSync.ps1" -Encoding UTF8

          # Register Task
          $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -WindowStyle Hidden -File `"C:\state-repo\StateSync.ps1`""
          $trigger = New-ScheduledTaskTrigger -AtLogOn
          $principal = New-ScheduledTaskPrincipal -GroupId "BUILTIN\Administrators" -RunLevel Highest
          Register-ScheduledTask -TaskName "RDPStateSync" -Action $action -Trigger $trigger -Principal $principal -Force | Out-Null

          # Setup Startup InitScripts
          $logonScript = @'
          $initDir = "C:\state-repo\InitScripts"
          if (Test-Path $initDir) {
              Get-ChildItem -Path $initDir -File | ForEach-Object {
                  if ($_.Extension -eq ".ps1") { Invoke-Expression $_.FullName }
                  elseif ($_.Extension -eq ".py") { Start-Process "python" -ArgumentList $_.FullName -Wait }
                  elseif ($_.Extension -eq ".bat" -or $_.Extension -eq ".cmd") { Start-Process $_.FullName -Wait }
              }
          }
          '@
          $logonScript | Out-File -FilePath "C:\state-repo\Run-InitScripts.ps1" -Encoding UTF8
          if (-not (Test-Path "C:\state-repo\InitScripts")) { New-Item -Path "C:\state-repo\InitScripts" -ItemType Directory -Force | Out-Null }
          $startupFolder = "C:\Users\${{ env.RDP_USER }}\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
          New-Item -Path $startupFolder -ItemType Directory -Force -ErrorAction SilentlyContinue | Out-Null
          $WshShell = New-Object -comObject WScript.Shell
          $Shortcut = $WshShell.CreateShortcut("$startupFolder\InitScriptsHook.lnk")
          $Shortcut.TargetPath = "powershell.exe"; $Shortcut.Arguments = "-ExecutionPolicy Bypass -WindowStyle Hidden -File C:\state-repo\Run-InitScripts.ps1"; $Shortcut.Save()

      - name: Deploy Save-Runtime Idle Monitor
        shell: powershell
        run: |
          if ('${{ env.SAVE_RUNTIME }}' -eq 'true') {
              $idleDaemon = @'
              Add-Type @"
              using System;
              using System.Runtime.InteropServices;
              public class IdleTime {
                  [StructLayout(LayoutKind.Sequential)]
                  struct LASTINPUTINFO { public uint cbSize; public uint dwTime; }
                  [DllImport("user32.dll")]
                  static extern bool GetLastInputInfo(ref LASTINPUTINFO plii);
                  public static uint GetIdle() {
                      LASTINPUTINFO info = new LASTINPUTINFO();
                      info.cbSize = (uint)Marshal.SizeOf(info);
                      GetLastInputInfo(ref info);
                      return (uint)Environment.TickCount - info.dwTime;
                  }
              }
          "@
              $idleTimeoutMs = 15 * 60 * 1000 # 15 minutes
              while($true) {
                  Start-Sleep -Seconds 10
                  if (Test-Path "C:\state-repo\idle_disabled.flag") { continue }
                  $idle = [IdleTime]::GetIdle()
                  if ($idle -gt $idleTimeoutMs) {
                      $wsh = New-Object -ComObject WScript.Shell
                      $btn = $wsh.Popup("Idle Timeout (15m). Shutdown in 60s.`n`nClick OK to stay.", 60, "Save Runtime", 48)
                      if ($btn -eq -1) { New-Item "C:\state-repo\end_run.flag" -Force; exit }
                  }
              }
          '@
              $idleDaemon | Out-File "C:\state-repo\SaveRuntimeDaemon.ps1" -Encoding UTF8
              
              $action2 = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -WindowStyle Hidden -File `"C:\state-repo\SaveRuntimeDaemon.ps1`""
              Register-ScheduledTask -TaskName "RDPIdleMonitor" -Action $action2 -Trigger (New-ScheduledTaskTrigger -AtLogOn) -Principal (New-ScheduledTaskPrincipal -GroupId "BUILTIN\Administrators" -RunLevel Highest) -Force | Out-Null
              
              $toggleScript = @'
              $flag = "C:\state-repo\idle_disabled.flag"
              $wshell = New-Object -ComObject Wscript.Shell
              if (Test-Path $flag) { Remove-Item $flag -Force; $wshell.Popup("Auto-Shutdown ENABLED.", 4, "Status", 64) } 
              else { New-Item $flag -ItemType File -Force; $wshell.Popup("Auto-Shutdown DISABLED.", 4, "Status", 48) }
              '@
              $toggleScript | Out-File "C:\state-repo\Toggle-AutoShutdown.ps1" -Encoding UTF8
              
              $publicDesktop = [Environment]::GetFolderPath("CommonDesktopDirectory")
              Copy-Item "C:\state-repo\Toggle-AutoShutdown.ps1" "$publicDesktop\Toggle-AutoShutdown.ps1" -Force
          }

      - name: Establish Tailscale VPN
        shell: powershell
        env:
          TS_API: ${{ secrets.TAILSCALE_API_KEY }}
          TS_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
        run: |
          $hostname = "${{ env.RDP_USER }}"
          if (-not [string]::IsNullOrWhiteSpace($env:TS_API)) {
              $headers = @{ "Authorization" = "Basic " + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$($env:TS_API):")) }
              try {
                  $devs = (Invoke-RestMethod "https://api.tailscale.com/api/v2/tailnet/$env:TS_TAILNET/devices" -Headers $headers).devices
                  $devs | Where-Object { $_.hostname -eq $hostname } | ForEach-Object { Invoke-RestMethod "https://api.tailscale.com/api/v2/device/$($_.id)" -Headers $headers -Method Delete }
              } catch {}
          }
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "$env:TEMP\tailscale.exe"
          Start-Process "$env:TEMP\tailscale.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="$hostname"
          
          $tsIP = $null; $i = 0
          while (-not $tsIP -and $i -lt 20) {
              $raw = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
              if ($raw -match "^100\.") { $tsIP = $raw.Trim() } else { Start-Sleep 5; $i++ }
          }
          if (-not $tsIP) { exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: RDP Interactive Session
        shell: powershell
        run: |
          Write-Host "RDP: $env:TAILSCALE_IP `nUser: ${{ env.RDP_USER }} `nPass: ${{ env.RDP_PASS }}"
          $logFile = "C:\state-repo\Logs\SyncDaemon.log"; $lastPos = 0
          while ((Get-Date) -lt (Get-Date).AddMinutes(350)) {
              if (Test-Path "C:\state-repo\end_run.flag") { break }
              if (Test-Path $logFile) {
                  $fs=[System.IO.FileStream]::new($logFile,[System.IO.FileMode]::Open,[System.IO.FileAccess]::Read,[System.IO.FileShare]::ReadWrite)
                  $fs.Seek($lastPos,0)|Out-Null; $r=[System.IO.StreamReader]::new($fs)
                  while(!$r.EndOfStream){Write-Host $r.ReadLine()}; $lastPos=$fs.Position; $r.Close(); $fs.Close()
              }
              Start-Sleep 5
          }

      - name: Emergency Teardown
        if: always()
        shell: powershell
        run: |
          Unregister-ScheduledTask "RDPStateSync" -ErrorAction SilentlyContinue
          try {
              $sid = (New-Object System.Security.Principal.NTAccount('${{ env.RDP_USER }}')).Translate([System.Security.Principal.SecurityIdentifier]).value
              if (Test-Path "Registry::HKEY_USERS\$sid") {
                  Set-Location C:\state-repo
                  git config user.name "Emergency"; git config user.email "daemon@rdp.local"
                  reg export "HKEY_USERS\$sid\Software\Microsoft\Windows\CurrentVersion\Themes" "Registry\Themes.reg" /y
                  git add .; git commit -m "Emergency Save" --quiet
                  git pull origin main --rebase --quiet; git push origin main --quiet
              }
          } catch {}
