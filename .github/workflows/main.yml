name: RDP-Static-Persistent-Final

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Clone Existing Tailwind Repository
        shell: powershell
        run: |
          # Dynamically clone your existing tailwind-rdp repository bypassing password prompts
          $repoUrl = "https://x-access-token:${{ secrets.GH_PAT }}@github.com/cradixo/tailwind-rdp.git"
          git clone $repoUrl C:\state-repo
          
          if (-not (Test-Path "C:\state-repo\.git")) {
            Write-Error "Failed to clone state repository. Ensure 'cradixo/tailwind-rdp' exists and GH_PAT secret is correct."
            exit 1
          }

      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      - name: Create RDP User
        run: |
          $username = "cardersparadox"
          $password = "Carding.Git!2024"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

      - name: Deploy Auto-Sync & Logging Agent to User Session
        run: |
          $startupFolder = "C:\Users\cardersparadox\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
          New-Item -Path $startupFolder -ItemType Directory -Force
          
          # Creating the advanced payload script with file-backed logging
          $syncScript = @"
          `$ErrorActionPreference = 'SilentlyContinue'
          `$stateRepo = 'C:\state-repo'
          `$logDir = "`$stateRepo\Logs"
          `$logFile = "`$logDir\SyncAgent.log"
          `$restoredFlag = "`$env:TEMP\registry_restored.flag"

          # Ensure Log Directory Exists
          if (-not (Test-Path `$logDir)) { New-Item -Path `$logDir -ItemType Directory -Force | Out-Null }

          # Centralized Timestamp Logging Function
          function Write-Log {
              param([string]`$Message)
              `$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              `$logLine = "[`$timestamp] `$Message"
              Out-File -FilePath `$logFile -InputObject `$logLine -Append -Encoding UTF8
          }

          Write-Log "========================================"
          Write-Log "Sync Agent Initialized. RDP User: `$env:USERNAME"
          Write-Log "========================================"

          # 1. First-Run Registry Import (Injects Personalization & Taskbar configurations)
          if (-not (Test-Path `$restoredFlag)) {
              if (Test-Path "`$stateRepo\Registry") {
                  Write-Log "Found existing Registry backups. Starting UI configuration import..."
                  Get-ChildItem -Path "`$stateRepo\Registry" -Filter "*.reg" | ForEach-Object { 
                      `$importResult = Start-Process -FilePath "reg.exe" -ArgumentList "import `"`$(`$_.FullName)`"" -Wait -PassThru
                      Write-Log "Imported `$(`$_.Name) with exit code: `$(`$importResult.ExitCode)"
                  }
                  Write-Log "Restarting Windows Explorer to instantly apply visual changes."
                  Stop-Process -Name explorer -Force
              } else {
                  Write-Log "No existing Registry folder found. Proceeding with fresh configuration."
              }
              New-Item -Path `$restoredFlag -ItemType File | Out-Null
              Write-Log "Restoration flag created. Skipping future imports for this session."
          }

          # 2. Continuous Synchronization & Telemetry Loop
          while (`$true) {
              Start-Sleep -Seconds 300
              Write-Log "Initiating 5-minute routine sync and export cycle..."
              
              New-Item -Path "`$stateRepo\Registry" -ItemType Directory -Force | Out-Null
              
              # Export crucial Configurations
              reg export "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" "`$stateRepo\Registry\Personalize.reg" /y
              reg export "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" "`$stateRepo\Registry\ExplorerAdvanced.reg" /y
              reg export "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3" "`$stateRepo\Registry\StuckRects3.reg" /y
              reg export "HKCU\Software\Microsoft\Windows\DWM" "`$stateRepo\Registry\DWM.reg" /y
              reg export "HKCU\Control Panel\Desktop" "`$stateRepo\Registry\Desktop.reg" /y
              Write-Log "Native registry keys exported successfully."
              
              # Push mutations (and this exact log file) to GitHub
              Set-Location `$stateRepo
              git config user.name "RDP Sync Agent"
              git config user.email "agent@rdp.local"
              
              Write-Log "Pulling latest remote changes (rebase)..."
              `$pullOutput = git pull origin main --rebase 2>&1
              Write-Log "Git Pull Output: `$pullOutput"
              
              `$status = git status --porcelain Registry/ Logs/
              if (`$status) {
                  Write-Log "Changes detected in Registry or Logs. Committing..."
                  git add Registry\*.reg Logs\*.log
                  `$commitMsg = "Auto-save Windows UI & Telemetry `$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
                  git commit -m "`$commitMsg" 2>&1 | Out-Null
                  
                  Write-Log "Pushing to GitHub..."
                  `$pushOutput = git push origin main 2>&1
                  Write-Log "Git Push Output: `$pushOutput"
              }
          }
          "@
          Out-File -FilePath "$startupFolder\StateSync.ps1" -InputObject $syncScript -Encoding UTF8
          
          # VBScript to ensure the PowerShell agent runs invisibly on login without disturbing the user
          $vbsLauncher = @"
          Set objShell = CreateObject("WScript.Shell")
          objShell.Run "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File ""$startupFolder\StateSync.ps1""", 0, False
          "@
          Out-File -FilePath "$startupFolder\Launcher.vbs" -InputObject $vbsLauncher -Encoding UTF8

      - name: Install and Connect Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "$env:TEMP\tailscale.exe"
          Start-Process -FilePath "$env:TEMP\tailscale.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="cardersparadox"
          
          $tsIP = $null; $retries = 0
          while (-not $tsIP -and $retries -lt 12) {
              $tsIP = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4).Trim()
              Start-Sleep -Seconds 5; $retries++
          }
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Maintain Runner Session
        shell: powershell
        run: |
          Write-Host "================ RDP ACCESS ================"
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "Username: cardersparadox"
          Write-Host "Password: Carding.Git!2024"
          Write-Host "============================================"
          Write-Host "Connecting via RDP will launch the invisible Sync & Logging Agent."
          Write-Host "Taskbar settings and detailed Session Logs will automatically push to your 'tailwind-rdp' repo every 5 minutes."
          
          # This blocking loop forces the Azure VM to stay alive for 350 minutes, executing the "exploit" mechanism.
          $endTime = (Get-Date).AddMinutes(350)
          while ((Get-Date) -lt $endTime) {
              Start-Sleep -Seconds 60
          }
