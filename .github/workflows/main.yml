name: RDP-Static-Persistent-Final

on:
  workflow_dispatch:

permissions:
  contents: write  # Crucial: Grants the native GITHUB_TOKEN permission to push state logs

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Clone Existing Tailwind Repository
        shell: powershell
        env:
          MY_PAT: ${{ secrets.GH_PAT }}
          NATIVE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Intelligent fallback: Use custom GH_PAT if it exists, otherwise fall back to native repo token.
          $token = $env:MY_PAT
          if ([string]::IsNullOrWhiteSpace($token)) {
              Write-Host "GH_PAT secret is empty or missing. Falling back to built-in GITHUB_TOKEN..."
              $token = $env:NATIVE_TOKEN
          }
          
          if ([string]::IsNullOrWhiteSpace($token)) {
              Write-Error "CRITICAL FAILURE: Both GH_PAT and GITHUB_TOKEN are empty. Cannot authenticate to GitHub."
              exit 1
          }

          # Dynamically clone your existing tailwind-rdp repository using the resolved token
          $repoUrl = "https://x-access-token:$token@github.com/cradixo/tailwind-rdp.git"
          
          Write-Host "Initiating Git Clone sequence..."
          git clone $repoUrl C:\state-repo
          
          if (-not (Test-Path "C:\state-repo\.git")) {
            Write-Error "Failed to clone state repository. Authentication was rejected by GitHub. Check your token scopes."
            exit 1
          }
          Write-Host "Repository cloned successfully using native loopback authentication."

      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      - name: Create RDP User
        run: |
          $username = "cardersparadox"
          $password = "Carding.Git!2024"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

      - name: Deploy Auto-Sync & Logging Agent to User Session
        run: |
          $startupFolder = "C:\Users\cardersparadox\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
          New-Item -Path $startupFolder -ItemType Directory -Force
          
          # Creating the advanced payload script with file-backed logging
          $syncScript = @"
          `$ErrorActionPreference = 'SilentlyContinue'
          `$stateRepo = 'C:\state-repo'
          `$logDir = "`$stateRepo\Logs"
          `$logFile = "`$logDir\SyncAgent.log"
          `$restoredFlag = "`$env:TEMP\registry_restored.flag"

          # Ensure Log Directory Exists
          if (-not (Test-Path `$logDir)) { New-Item -Path `$logDir -ItemType Directory -Force | Out-Null }

          # Centralized Timestamp Logging Function
          function Write-Log {
              param([string]`$Message)
              `$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              `$logLine = "[`$timestamp] `$Message"
              Out-File -FilePath `$logFile -InputObject `$logLine -Append -Encoding UTF8
          }

          Write-Log "========================================"
          Write-Log "Sync Agent Initialized. RDP User: `$env:USERNAME"
          Write-Log "========================================"

          # 1. First-Run Registry Import (Injects Personalization & Taskbar configurations)
          if (-not (Test-Path `$restoredFlag)) {
              if (Test-Path "`$stateRepo\Registry") {
                  Write-Log "Found existing Registry backups. Starting UI configuration import..."
                  Get-ChildItem -Path "`$stateRepo\Registry" -Filter "*.reg" | ForEach-Object { 
                      `$importResult = Start-Process -FilePath "reg.exe" -ArgumentList "import `"`$(`$_.FullName)`"" -Wait -PassThru
                      Write-Log "Imported `$(`$_.Name) with exit code: `$(`$importResult.ExitCode)"
                  }
                  Write-Log "Restarting Windows Explorer to instantly apply visual changes."
                  Stop-Process -Name explorer -Force
              } else {
                  Write-Log "No existing Registry folder found. Proceeding with fresh configuration."
              }
              New-Item -Path `$restoredFlag -ItemType File | Out-Null
              Write-Log "Restoration flag created. Skipping future imports for this session."
          }

          # 2. Continuous Synchronization & Telemetry Loop
          while (`$true) {
              Start-Sleep -Seconds 300
              Write-Log "Initiating 5-minute routine sync and export cycle..."
              
              New-Item -Path "`$stateRepo\Registry" -ItemType Directory -Force | Out-Null
              
              # Export crucial Configurations
              reg export "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" "`$stateRepo\Registry\Personalize.reg" /y
              reg export "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" "`$stateRepo\Registry\ExplorerAdvanced.reg" /y
              reg export "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3" "`$stateRepo\Registry\StuckRects3.reg" /y
              reg export "HKCU\Software\Microsoft\Windows\DWM" "`$stateRepo\Registry\DWM.reg" /y
              reg export "HKCU\Control Panel\Desktop" "`$stateRepo\Registry\Desktop.reg" /y
              Write-Log "Native registry keys exported successfully."
              
              # Push mutations (and this exact log file) to GitHub
              Set-Location `$stateRepo
              git config user.name "RDP Sync Agent"
              git config user.email "agent@rdp.local"
              
              Write-Log "Pulling latest remote changes (rebase)..."
              `$pullOutput = git pull origin main --rebase 2>&1
              Write-Log "Git Pull Output: `$pullOutput"
              
              `$status = git status --porcelain Registry/ Logs/
              if (`$status) {
                  Write-Log "Changes detected in Registry or Logs. Committing..."
                  git add Registry\*.reg Logs\*.log
                  `$commitMsg = "Auto-save Windows UI & Telemetry `$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
                  git commit -m "`$commitMsg" 2>&1 | Out-Null
                  
                  Write-Log "Pushing to GitHub..."
                  `$pushOutput = git push origin main 2>&1
                  Write-Log "Git Push Output: `$pushOutput"
              }
          }
          "@
          Out-File -FilePath "$startupFolder\StateSync.ps1" -InputObject $syncScript -Encoding UTF8
          
          # VBScript to ensure the PowerShell agent runs invisibly on login without disturbing the user
          $vbsLauncher = @"
          Set objShell = CreateObject("WScript.Shell")
          objShell.Run "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File ""$sta
