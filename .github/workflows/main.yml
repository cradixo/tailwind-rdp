name: RDP-Static-Persistent-Final

env:
  TZ: 'Asia/Kolkata'

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: "[SETUP 1/6] Forcefully Cleanup Stale Tailscale Device via API"
        env:
          TS_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          TS_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
          HOSTNAME: "cardersparadox"
        run: |
          $headers = @{ "Authorization" = "Bearer $($env:TS_API_KEY)" }
          $devicesUri = "https://api.tailscale.com/api/v2/tailnet/$($env:TS_TAILNET)/devices"
          
          try {
            $devices = Invoke-RestMethod -Uri $devicesUri -Headers $headers
          } catch {
            Write-Error "API call failed. Please verify your TAILSCALE_TAILNET secret ('$($env:TS_TAILNET)') and ensure your API Key has Read/Write permissions for Devices."
            exit 1
          }

          $device = $devices.devices | Where-Object { $_.hostname -eq $env:HOSTNAME }
          
          if ($device) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Found old device '$($device.hostname)'. Deleting it to ensure a static address."
            $deleteUri = "https://api.tailscale.com/api/v2/device/$($device.id)"
            Invoke-RestMethod -Uri $deleteUri -Method Delete -Headers $headers
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Device deleted successfully."
          } else {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] No previous device named '$($env:HOSTNAME)' found."
          }

      - name: "[SETUP 2/6] Restore Cache to Staging Area"
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: D:\a\cache-staging
          key: rdp-user-settings-v8

      - name: "[SETUP 3/6] Configure Windows RDP"
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          # Enable RDP logging for debugging
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "EnableLogging" -Value 1

      - name: "[SETUP 4/6] Create RDP User and Apply Settings"
        env:
          CACHE_HIT: ${{ steps.cache-restore.outputs.cache-hit }}
        run: |
          $username = "cardersparadox"
          $password = "Carding.Git!2024"
          $userProfile = "C:\Users\$username"
          
          # Delete user if exists to ensure clean state
          $userExists = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
          if ($userExists) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] User already exists. Removing..."
            Remove-LocalUser -Name $username
            Start-Sleep -Seconds 2
          }
          
          # Create user with password that never expires
          New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          # Wait for profile creation
          $retries = 0
          $maxRetries = 60
          while (-not (Test-Path "$userProfile\NTUSER.DAT") -and $retries -lt $maxRetries) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Waiting for user profile to initialize... ($retries/$maxRetries)"
            Start-Sleep -Seconds 2
            $retries++
          }
          
          if ($env:CACHE_HIT -eq 'true') {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Cache hit. Applying restored settings..."
            
            # Load user registry hive for offline editing
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Loading user registry hive..."
            reg load "HKU\TempUser" "$userProfile\NTUSER.DAT"
            
            # Check if we have a backed up registry file
            if (Test-Path "D:\a\cache-staging\user-registry.reg") {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Importing registry settings..."
              # Import registry settings to the loaded hive
              reg import "D:\a\cache-staging\user-registry.reg"
            }
            
            # Unload the registry hive
            reg unload "HKU\TempUser"
            
            # Copy files from cache
            if (Test-Path "D:\a\cache-staging\Files") {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Copying files..."
              robocopy "D:\a\cache-staging\Files" "$userProfile" /E /Z /R:2 /W:5 /MT:16
            }
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Settings applied successfully."
          } else {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Cache miss. Starting with fresh settings."
          }
          
          echo "RDP_USER=$username" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: "[SETUP 5/6] Install and Connect Tailscale"
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "$env:TEMP\tailscale.exe"
          Start-Process -FilePath "$env:TEMP\tailscale.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="cardersparadox"
          
          $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          if (-not $tsIP) { Start-Sleep -s 10; $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 }
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      
      - name: "[ACTIVE 6/6] Maintain Session and Auto-Save"
        shell: powershell
        run: |
          Write-Host "================ RDP ACCESS (IST Time) ================"
          Write-Host "Address:  cardersparadox"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host "======================================================"
          
          $userProfilePath = "C:\Users\cardersparadox"
          $stagingPath = "D:\a\cache-staging"
          
          # Create staging directory structure
          New-Item -Path "$stagingPath\Files" -ItemType Directory -Force | Out-Null
          
          # Function to backup user settings
          function Backup-UserSettings {
            param($UserProfile, $StagingPath)
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Starting backup process..."
            
            # Load user registry hive for offline backup
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Loading registry hive for backup..."
            reg load "HKU\TempUser" "$UserProfile\NTUSER.DAT"
            
            # Export registry settings
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Exporting registry settings..."
            reg export "HKU\TempUser" "$StagingPath\user-registry.reg" /y
            
            # Unload the registry hive
            reg unload "HKU\TempUser"
            
            # Backup critical folders (using robocopy for resilience)
            $foldersToBackup = @(
              "AppData\Local\Microsoft\Edge",
              "AppData\Local\Microsoft\Windows",
              "AppData\Roaming\Microsoft\Windows",
              "AppData\Local\Packages\Microsoft.Windows.ShellExperienceHost_cw5n1h2txyewy",
              "AppData\Local\Microsoft\WindowsShell"
            )
            
            foreach ($folder in $foldersToBackup) {
              $source = "$UserProfile\$folder"
              $dest = "$StagingPath\Files\$folder"
              
              if (Test-Path $source) {
                New-Item -Path $dest -ItemType Directory -Force | Out-Null
                robocopy $source $dest /E /Z /R:2 /W:5 /MT:16 /XD "Cache" "Temp" /XF "*.tmp" "*.temp" | Out-Null
              }
            }
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Backup completed successfully."
          }
          
          # Initial backup
          Backup-UserSettings -UserProfile $userProfilePath -StagingPath $stagingPath
          
          # Continuous backup loop
          while ($true) {
            Start-Sleep -Seconds 10
            Backup-UserSettings -UserProfile $userProfilePath -StagingPath $stagingPath
          }
          
      - name: Save Staged Settings to Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: D:\a\cache-staging
          key: rdp-user-settings-v8
