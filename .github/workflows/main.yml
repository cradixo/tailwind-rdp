name: RDP-Static-Ephemeral

env:
  TZ: 'Asia/Kolkata'

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: "[SETUP 1/5] Forcefully Cleanup Stale Tailscale Device via API"
        env:
          TS_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
          TS_TAILNET: ${{ secrets.TAILSCALE_TAILNET }}
          HOSTNAME: "cardersparadox"
        run: |
          $headers = @{ "Authorization" = "Bearer $($env:TS_API_KEY)" }
          $devicesUri = "https://api.tailscale.com/api/v2/tailnet/$($env:TS_TAILNET)/devices"
          try { $devices = Invoke-RestMethod -Uri $devicesUri -Headers $headers } catch { Write-Error "API call failed."; exit 1 }
          $device = $devices.devices | Where-Object { $_.hostname -eq $env:HOSTNAME }
          if ($device) {
            Write-Host "Found and deleting old device '$($device.hostname)'."
            Invoke-RestMethod -Uri "https://api.tailscale.com/api/v2/device/$($device.id)" -Method Delete -Headers $headers
          } else { Write-Host "No previous device named '$($env:HOSTNAME)' found." }

      - name: "[SETUP 2/5] Configure Windows RDP"
        run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force; netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      - name: "[SETUP 3/5] Create RDP User"
        env:
          RDP_USER: "cardersparadox"
          RDP_PASS: "Carding.Git!2024"
        run: |
          # Create the user account
          $userProfile = "C:\Users\$($env:RDP_USER)"
          New-LocalUser -Name $env:RDP_USER -Password (ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force) -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USER
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USER
          
          # Force the user profile to be created
          Write-Host "Forcing user profile creation..."
          $pinfo = New-Object System.Diagnostics.ProcessStartInfo
          $pinfo.FileName = "runas.exe"
          $pinfo.RedirectStandardInput = $true
          $pinfo.UseShellExecute = $false
          $pinfo.Arguments = "/user:$($env:RDP_USER) cmd.exe /c exit"
          $p = New-Object System.Diagnostics.Process
          $p.StartInfo = $pinfo
          $p.Start() | Out-Null
          $p.StandardInput.WriteLine($env:RDP_PASS)
          $p.WaitForExit()

          # Wait and check for the profile directory to exist with retries
          $profileDesktopPath = "$userProfile\Desktop"
          $maxRetries = 5
          $retryDelay = 3 # seconds
          for ($i = 1; $i -le $maxRetries; $i++) {
              Write-Host "Checking for profile... Attempt $i"
              if (Test-Path $profileDesktopPath) {
                  Write-Host "Profile found."
                  break
              }
              if ($i -lt $maxRetries) {
                  Write-Host "Profile not found yet. Waiting for $retryDelay seconds..."
                  Start-Sleep -Seconds $retryDelay
              }
          }

          if (-not (Test-Path $profileDesktopPath)) {
              Write-Error "CRITICAL: Failed to create user profile after $maxRetries attempts."
              Write-Host "Listing C:\Users directory for debugging..."
              Get-ChildItem -Path C:\Users -Force | Select-Object FullName, LastWriteTime
              exit 1
          }

          Write-Host "SUCCESS: User profile created."
          echo "RDP_USER=$($env:RDP_USER)" >> $env:GITHUB_ENV
          echo "RDP_PASS=$($env:RDP_PASS)" >> $env:GITHUB_ENV

      - name: "[SETUP 4/5] Install and Connect Tailscale"
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "$env:TEMP\tailscale.exe"
          Start-Process -FilePath "$env:TEMP\tailscale.exe" -ArgumentList "/quiet" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="cardersparadox"
          Start-Sleep -s 5
          $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      
      - name: "[ACTIVE 5/5] Maintain Session"
        shell: powershell
        run: |
          Write-Host "================ RDP ACCESS ================"
          Write-Host "Address:  cardersparadox OR $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host "======================================================"
          Write-Host "SUCCESS: Setup complete. The session will be kept alive."
          while ($true) { Start-Sleep -Seconds 300; Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Heartbeat: Session active." }
